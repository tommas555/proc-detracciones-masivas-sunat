{% extends "_base.html" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block extra_css %}
<style>

    body > .container {
            max-width: none !important;
            width: 100% !important;
        }

    /* Cabecera fija en la tabla */
    .table-responsive {
        max-height: calc(100vh - 450px);
        overflow-y: auto;
        position: relative;
    }

    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa; /* Color de fondo de la cabecera */
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }

    /* Eliminar padding lateral del container */
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
        min-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
    }
    
    /* Tabla ocupa todo el espacio disponible */
    .table-responsive {
        flex: 1;
        overflow: auto;
        max-height: calc(100vh - 450px);
        margin-left: -1rem;
        margin-right: -1rem;
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    /* Tabla ancho 100% */
    .table {
        width: 100%;
        margin-bottom: 0;
    }
    
    /* Ajustar padding de celdas */
    .table th, .table td {
        padding: 0.75rem;
        white-space: nowrap;
    }
    
    /* Columna de usuario puede tener wrap */
    .table td:nth-child(2) {
        white-space: normal;
        min-width: 150px;
    }
    
    /* Columna email puede tener wrap */
    .table td:nth-child(4) {
        white-space: normal;
        min-width: 180px;
    }

    /* ✅ AGREGAR: Columna celular */
    .table td:nth-child(5) {
        white-space: nowrap;
        min-width: 120px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Gestión de Usuarios</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('admin.export_users') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-download"></i> Exportar CSV
            </a>
        </div>
    </div>

    
    <!-- Tarjetas de Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center border-warning">
                <div class="card-body py-3">
                    <h6 class="card-title text-warning mb-1">Pendientes Verificación</h6>
                    <p class="card-text display-6 mb-0">{{ pending_verification }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center" style="border: 2px solid #fd7e14;">
                <div class="card-body py-3">
                    <h6 class="card-title mb-1" style="color: #fd7e14;">Pendientes Aprobación</h6>
                    <p class="card-text display-6 mb-0">{{ pending_review }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-info">
                <div class="card-body py-3">
                    <h6 class="card-title text-info mb-1">Trial Activo</h6>
                    <p class="card-text display-6 mb-0">{{ trial_active }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-success">
                <div class="card-body py-3">
                    <h6 class="card-title text-success mb-1">Activos</h6>
                    <p class="card-text display-6 mb-0">{{ active }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-danger">
                <div class="card-body py-3">
                    <h6 class="card-title text-danger mb-1">Suspendidos</h6>
                    <p class="card-text display-6 mb-0">{{ suspended }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-secondary">
                <div class="card-body py-3">
                    <h6 class="card-title text-secondary mb-1">Total</h6>
                    <p class="card-text display-6 mb-0">{{ users|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Buscador y filtros -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <input type="text" 
                           name="search" 
                           class="form-control" 
                           placeholder="Buscar por email, usuario, nombre o apellido..." 
                           value="{{ search_query }}">
                </div>
                <div class="col-md-4">
                    <select name="status" class="form-select">
                        <option value="all" {{ 'selected' if status_filter == 'all' }}>Todos los estados</option>
                        <option value="PENDIENTE_VERIFICACION" {{ 'selected' if status_filter == 'PENDIENTE_VERIFICACION' }}>Pendientes Verificación</option>
                        <option value="PENDIENTE_APROBACION" {{ 'selected' if status_filter == 'PENDIENTE_APROBACION' }}>Pendientes Aprobación</option>                        <option value="TRIAL_ACTIVO" {{ 'selected' if status_filter == 'TRIAL_ACTIVO' }}>Trial Activo</option>
                        <option value="ACTIVO" {{ 'selected' if status_filter == 'ACTIVO' }}>Activos</option>
                        <option value="SUSPENDIDO" {{ 'selected' if status_filter == 'SUSPENDIDO' }}>Suspendidos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Buscar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="table-responsive shadow-sm">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th >Usuario</th>
                    <th >Plan Actual</th>
                    <th >Email</th>
                    <th>Celular</th>  <!-- ✅ NUEVA COLUMNA -->
                    <th>Email Verificado</th>
                    <th >Estado</th>
                    <th >Meses Pagados</th>
                    <th >Vencimiento</th>
                    <th >Acciones</th>
                </tr>
            </thead>

<tbody>
    {% for user in users %}
    {% set active_sub = user.get_active_subscription() %}
    <tr>
        <td>{{ user.id }}</td>
        <td>
            <div>
                <div class="fw-bold">{{ user.username }}</div>
                {% if user.first_name or user.last_name %}
                <div class="text-muted small">
                    {{ user.first_name or '' }} {{ user.last_name or '' }}
                </div>
                {% endif %}
                {% if user.role == 'admin' %}
                <span class="badge bg-danger mt-1">ADMIN</span>
                {% endif %}
            </div>
        </td>
        <td>
            {% if active_sub and active_sub.plan %}
                <span class="badge bg-primary">{{ active_sub.plan.name }}</span>
            {% elif user.account_status == 'TRIAL_ACTIVO' %}
                <span class="badge bg-info text-dark">Trial</span>
            {% else %}
                <span class="badge bg-secondary">Ninguno</span>
            {% endif %}
        </td>
        <td>{{ user.email or 'None' }}</td>
        <!-- ✅ AGREGAR ESTA COLUMNA AQUÍ -->
        <td>
            {% if user.phone %}
                <a href="https://wa.me/51{{ user.phone }}" 
                target="_blank" 
                class="text-decoration-none"
                title="Contactar por WhatsApp">
                    <i class="bi bi-whatsapp text-success"></i> {{ user.phone }}
                </a>
            {% else %}
                <span class="text-muted">-</span>
            {% endif %}
        </td>
        <td class="text-center">
            {% if user.email and user.is_email_verified %}
                <span class="badge bg-success">
                    <i class="bi bi-check-circle-fill"></i> Verificado
                </span>
            {% elif user.email and not user.is_email_verified %}
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle-fill"></i> Sin verificar
                </span>
            {% else %}
                <span class="badge bg-secondary">
                    <i class="bi bi-dash-circle"></i> Sin email
                </span>
            {% endif %}
        </td>
        <td>
            {% if user.account_status == 'PENDIENTE_VERIFICACION' %}
                <span class="badge bg-warning text-dark">PENDIENTE VERIFICACIÓN</span>
            {% elif user.account_status == 'PENDIENTE_REVISION' or user.account_status == 'PENDIENTE_PAGO' %}
                <span class="badge text-white" style="background-color: #fd7e14;">PENDIENTE APROBACIÓN</span>
            {% elif user.account_status == 'TRIAL_ACTIVO' %}
                <span class="badge bg-info text-dark">TRIAL ACTIVO</span>
            {% elif user.account_status == 'ACTIVO' %}
                <span class="badge bg-success">ACTIVO</span>
            {% elif user.account_status == 'SUSPENDIDO' %}
                <span class="badge bg-danger">SUSPENDIDO</span>
            {% else %}
                <span class="badge bg-secondary">{{ user.account_status }}</span>
            {% endif %}
        </td>
        <td class="text-center">
            {% if active_sub %}
                {{ ((active_sub.ends_at - active_sub.starts_at).days / 30) | round(0, 'floor') | int }}
            {% else %}
                0
            {% endif %}
        </td>
        <td>
            {% if active_sub and active_sub.ends_at %}
                {{ active_sub.ends_at.strftime('%d/%m/%Y') }}
            {% else %}
                -
            {% endif %}
        </td>
        <td class="text-center">
            <div class="dropdown">
                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="actionsDropdown{{ user.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                    Acciones
                </button>
                <ul class="dropdown-menu" aria-labelledby="actionsDropdown{{ user.id }}">
                    {% if user.account_status == 'PENDIENTE_REVISION' %}
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modal{{ user.id }}">
                        <i class="bi bi-check-circle text-success"></i> Aprobar Pago
                    </a></li>
                    {% elif user.account_status == 'ACTIVO' %}
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalExtend{{ user.id }}">
                    <i class="bi bi-calendar-plus text-primary"></i> Extender Suscripción
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalEdit{{ user.id }}">
                        <i class="bi bi-pencil-square text-info"></i> Editar Suscripción
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="post" action="{{ url_for('admin.suspend_user', user_id=user.id) }}" style="display:inline;">
                            <button type="submit" class="dropdown-item text-warning" onclick='return confirm("¿Estás seguro de que quieres suspender a este usuario?");'>
                                <i class="bi bi-pause-circle"></i> Suspender Usuario
                            </button>
                        </form>
                    </li>
                    {% if user.role == 'admin' %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="post" action="{{ url_for('admin.remove_admin', user_id=user.id) }}" style="display:inline;">
                            <button type="submit" class="dropdown-item text-danger" onclick='return confirm("¿Quitar privilegios de administrador?");'>
                                <i class="bi bi-shield-x"></i> Quitar Admin
                            </button>
                        </form>
                    </li>
                    {% else %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="post" action="{{ url_for('admin.make_admin', user_id=user.id) }}" style="display:inline;">
                            <button type="submit" class="dropdown-item text-success">
                                <i class="bi bi-shield-check"></i> Hacer Admin
                            </button>
                        </form>
                    </li>
                    {% endif %}
                    {% elif user.account_status == 'SUSPENDIDO' %}
                    <li>
                        <form method="post" action="{{ url_for('admin.reactivate_user', user_id=user.id) }}" style="display:inline;">
                            <button type="submit" class="dropdown-item text-success">
                                <i class="bi bi-play-circle"></i> Reactivar
                            </button>
                        </form>
                    </li>
                    <li>
                        <form method="post" action="{{ url_for('admin.set_pending', user_id=user.id) }}" style="display:inline;">
                            <button type="submit" class="dropdown-item text-warning">
                                <i class="bi bi-clock"></i> Poner Pendiente
                            </button>
                        </form>
                    </li>
                    {% else %}
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modal{{ user.id }}">
                        <i class="bi bi-person-check text-success"></i> Activar Usuario
                    </a></li>
                    {% endif %}

                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}" style="display:inline;">
                            <button type="submit" class="dropdown-item text-danger" onclick='return confirm("⚠️ ADVERTENCIA: Esta acción eliminará PERMANENTEMENTE al usuario y toda su información.\n\n¿Estás completamente seguro de eliminar a {{ user.email }}?");'>
                                <i class="bi bi-trash"></i> Eliminar Usuario
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>

        </table>
    </div>

    {% if not users %}
    <div class="alert alert-info text-center mt-3" role="alert">
        <i class="bi bi-info-circle"></i> No se encontraron usuarios con los filtros seleccionados.
    </div>
    {% endif %}
</div>

<!-- Modal -->
{% for user in users %}
<!-- Modal Extender (solo para ACTIVO) -->
{% if user.account_status == 'ACTIVO' %}
<div class="modal fade" id="modalExtend{{ user.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Extender suscripción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('admin.extend_subscription', user_id=user.id) }}">
                <div class="modal-body">
                    <p><strong>Usuario:</strong> {{ user.email }}</p>
                    <p><strong>Plan actual:</strong> {{ active_sub.plan.name if active_sub and active_sub.plan else 'Ninguno' }}</p>
                    
                    <div class="mb-3">
                        <label for="plan_id_extend_{{ user.id }}" class="form-label">Mantener o cambiar plan</label>
                        <select name="plan_id" id="plan_id_extend_{{ user.id }}" class="form-select" required>
                            {% for plan in plans %}
                                <option value="{{ plan.id }}" {% if active_sub and active_sub.plan_id == plan.id %}selected{% endif %}>
                                    {{ plan.name }} - S/. {{ (plan.price_monthly / 100)|int }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <label for="months_extend_{{ user.id }}" class="form-label">¿Cuántos meses AGREGAR?</label>
                    <input type="number" id="months_extend_{{ user.id }}" name="months" class="form-control" value="1" min="1" max="24" required>
                    <div class="form-text">Se SUMARÁN 30 días × meses a la fecha actual de vencimiento</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Extender</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Editar (solo para ACTIVO) -->
{% if user.account_status == 'ACTIVO' %}
<div class="modal fade" id="modalEdit{{ user.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar suscripción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('admin.edit_subscription', user_id=user.id) }}">
                <div class="modal-body">
                    <p><strong>Usuario:</strong> {{ user.email }}</p>
                    
                    <div class="mb-3">
                        <label for="plan_id_edit_{{ user.id }}" class="form-label">Seleccionar Plan</label>
                        <select name="plan_id" id="plan_id_edit_{{ user.id }}" class="form-select" required>
                            {% for plan in plans %}
                                <option value="{{ plan.id }}" {% if active_sub and active_sub.plan_id == plan.id %}selected{% endif %}>
                                    {{ plan.name }} - S/. {{ (plan.price_monthly / 100)|int }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <label for="months_edit_{{ user.id }}" class="form-label">¿Cuántos meses en TOTAL?</label>
                    <input type="number" id="months_edit_{{ user.id }}" name="months" class="form-control" value="1" min="1" max="24" required>
                    <div class="form-text">Se ESTABLECERÁ una nueva fecha de vencimiento (30 días × meses desde HOY)</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para otros estados (PENDIENTE, etc.) -->
{% if user.account_status != 'ACTIVO' and user.account_status != 'SUSPENDIDO' %}
<div class="modal fade" id="modal{{ user.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if user.account_status == 'PENDIENTE_REVISION' %}
                      Aprobar pago
                    {% else %}
                      Activar usuario
                    {% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('admin.approve_user', user_id=user.id) }}">
                <div class="modal-body">
                    {% if not user.is_email_verified %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Advertencia:</strong> Este usuario aún no ha verificado su email.
                        Se recomienda esperar a que lo verifique antes de asignarle un plan.
                    </div>
                    {% endif %}
                    <p><strong>Usuario:</strong> {{ user.email }}</p>
                    
                    <div class="mb-3">
                        <label for="plan_id_{{ user.id }}" class="form-label">Seleccionar Plan</label>
                        <select name="plan_id" id="plan_id_{{ user.id }}" class="form-select" required>
                            {% for plan in plans %}
                                <option value="{{ plan.id }}">{{ plan.name }} - S/. {{ (plan.price_monthly / 100)|int }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <label for="months{{ user.id }}" class="form-label">¿Cuántos meses?</label>
                    <input type="number" id="months{{ user.id }}" name="months" class="form-control" value="1" min="1" max="24" required>
                    <div class="form-text">Se calculará: 30 días × meses</div>
                    
                    {% if user.payment_proof_url %}
                    <div class="mt-3">
                      <a href="{{ user.payment_proof_url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver comprobante</a>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endfor %}
{% endblock %}