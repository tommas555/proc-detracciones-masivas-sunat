{% extends "_base.html" %} {% block title %}Recuperar contraseña{% endblock %}
{% block extra_css %}
<style>
  body {
    background: #f6f8fb;
  }
  .recovery-container {
    min-height: calc(100vh - 80px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }
  .recovery-card {
    max-width: 420px;
    width: 100%;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
    padding: 2rem;
  }
  .code-input {
    width: 3rem;
    height: 3rem;
    font-size: 1.5rem;
    font-weight: 600;
    text-align: center;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
  }
  .code-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    outline: none;
  }
  .btn-resend {
    color: #6c757d;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-resend:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #adb5bd;
  }
  .btn-resend:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
{% endblock %} {% block content %}
<div class="recovery-container">
  <div class="recovery-card">
    <h4 class="mb-4">Recuperar contraseña</h4>

    <div id="step-email">
      <p class="text-muted small mb-3">
        Ingresa tu correo electrónico para recibir un código de recuperación
      </p>

      <form id="form-email">
        <div class="mb-3">
          <input
            type="email"
            class="form-control"
            id="email"
            placeholder="correo@ejemplo.com"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100">
          Enviar código
        </button>
      </form>
    </div>

    <div id="step-code" class="d-none">
      <p class="text-muted small mb-3">
        Ingresa el código de 4 dígitos enviado a tu correo
      </p>

      <div class="d-flex gap-2 justify-content-center mb-3">
        <input
          type="text"
          maxlength="1"
          class="form-control code-input"
          data-index="0"
        />
        <input
          type="text"
          maxlength="1"
          class="form-control code-input"
          data-index="1"
        />
        <input
          type="text"
          maxlength="1"
          class="form-control code-input"
          data-index="2"
        />
        <input
          type="text"
          maxlength="1"
          class="form-control code-input"
          data-index="3"
        />
      </div>

      <div class="text-center mb-3">
        <button id="btn-resend-reset" class="btn-resend" type="button">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path
              fill-rule="evenodd"
              d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"
            />
            <path
              d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"
            />
          </svg>
          Reenviar código
        </button>
      </div>

      <div class="mb-3">
        <input
          type="password"
          class="form-control"
          id="new_password"
          placeholder="Nueva contraseña"
          minlength="6"
          required
        />
      </div>

      <div class="mb-3">
        <input
          type="password"
          class="form-control"
          id="confirm_password"
          placeholder="Confirmar contraseña"
          minlength="6"
          required
        />
      </div>

      <button id="btn-reset" class="btn btn-primary w-100" disabled>
        Restablecer contraseña
      </button>
    </div>

    <p class="text-center text-muted small mb-0 mt-3">
      <a href="{{ url_for('auth.login') }}" class="text-decoration-none"
        >Volver al inicio de sesión</a
      >
    </p>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  const stepEmail = document.getElementById("step-email");
  const stepCode = document.getElementById("step-code");
  const formEmail = document.getElementById("form-email");
  const emailInput = document.getElementById("email");
  const codeInputs = document.querySelectorAll(".code-input");
  const btnReset = document.getElementById("btn-reset");
  const btnResendReset = document.getElementById("btn-resend-reset");
  const newPassword = document.getElementById("new_password");
  const confirmPassword = document.getElementById("confirm_password");

  let userEmail = "";
  let currentInterval = null;
  let savedSVG = ""; // ← GUARDAR SVG AL INICIO
  const COOLDOWN_SECONDS = 30;

  // Guardar SVG cuando carga la página
  if (btnResendReset && btnResendReset.querySelector("svg")) {
    savedSVG = btnResendReset.querySelector("svg").outerHTML;
  }

  function startCooldown() {
    if (currentInterval) {
      clearInterval(currentInterval);
    }

    let remaining = COOLDOWN_SECONDS;
    btnResendReset.disabled = true;

    currentInterval = setInterval(() => {
      remaining--;
      btnResendReset.innerHTML = `${savedSVG} Reenviar (${remaining}s)`; // ← USAR savedSVG

      if (remaining <= 0) {
        clearInterval(currentInterval);
        currentInterval = null;
        btnResendReset.disabled = false;
        btnResendReset.innerHTML = `${savedSVG} Reenviar código`; // ← USAR savedSVG
      }
    }, 1000);
  }

  formEmail.addEventListener("submit", async (e) => {
    e.preventDefault();
    userEmail = emailInput.value.trim();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Enviando...";

    try {
      const res = await fetch("/auth/send-reset-code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: userEmail }),
      });

      const data = await res.json();

      if (data.ok) {
        stepEmail.classList.add("d-none");
        stepCode.classList.remove("d-none");
        codeInputs[0].focus();
        showToast("Código enviado a tu correo", "success");
        startCooldown();
      } else {
        showToast(data.msg, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    } catch (error) {
      showToast("Error de conexión", "error");
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  btnResendReset.addEventListener("click", async () => {
    btnResendReset.disabled = true;
    btnResendReset.innerHTML = "<span>Enviando...</span>";

    try {
      const res = await fetch("/auth/send-reset-code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: userEmail }),
      });

      const data = await res.json();

      if (data.ok) {
        showToast("Código reenviado", "success");
        startCooldown(); // ← Esto ahora usará savedSVG
      } else {
        showToast(data.msg, "error");
        btnResendReset.disabled = false;
        btnResendReset.innerHTML = `${savedSVG} Reenviar código`;
      }
    } catch (error) {
      showToast("Error de conexión", "error");
      btnResendReset.disabled = false;
      btnResendReset.innerHTML = `${savedSVG} Reenviar código`;
    }
  });

  codeInputs.forEach((inp, idx) => {
    inp.addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, "");
      if (e.target.value.length === 1 && idx < 3) {
        codeInputs[idx + 1].focus();
      }
      checkComplete();
    });

    inp.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !e.target.value && idx > 0) {
        codeInputs[idx - 1].focus();
      }
    });
  });

  function checkComplete() {
    const codeFilled = [...codeInputs].every((i) => i.value.length === 1);
    const passwordsFilled =
      newPassword.value.length >= 6 && confirmPassword.value.length >= 6;
    btnReset.disabled = !(codeFilled && passwordsFilled);
  }

  newPassword.addEventListener("input", checkComplete);
  confirmPassword.addEventListener("input", checkComplete);

  btnReset.addEventListener("click", async () => {
    const code = [...codeInputs].map((i) => i.value).join("");

    if (newPassword.value !== confirmPassword.value) {
      showToast("Las contraseñas no coinciden", "error");
      return;
    }

    btnReset.disabled = true;
    btnReset.textContent = "Procesando...";

    try {
      const res = await fetch("/auth/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: userEmail,
          code: code,
          new_password: newPassword.value,
        }),
      });

      const data = await res.json();

      if (data.ok) {
        showToast("Contraseña actualizada correctamente", "success");
        setTimeout(() => {
          window.location.href = "/auth/login";
        }, 1500);
      } else {
        showToast(data.msg, "error");
        btnReset.disabled = false;
        btnReset.textContent = "Restablecer contraseña";
      }
    } catch (error) {
      showToast("Error de conexión", "error");
      btnReset.disabled = false;
      btnReset.textContent = "Restablecer contraseña";
    }
  });
</script>
{% endblock %}
